___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Raptor Tag Monitoring",
  "categories": ["TAG_MANAGEMENT", "ANALYTICS","UTILITY"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "Raptor",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "This is a template for Raptor Tag Monitoring. Use this to monitor any tag in Google Tag Manager.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "endPoint",
    "displayName": "GET request endpoint",
    "simpleValueType": true,
    "help": "Provide the URL to which the GET request with tag data is sent.",
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^https://.+"
        ],
        "errorMessage": "The endpoint must be a valid HTTPS URL"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "token",
    "displayName": "Security Token",
    "simpleValueType": true,
    "help": "This is your private security token that we use to authenticate you with our servers",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Load the required APIs
const addEventCallback = require('addEventCallback');
const readFromDataLayer = require('copyFromDataLayer');
const sendPixel = require('sendPixel');
const getTimestamp = require('getTimestamp');
const log = require('logToConsole');
const getUrl = require('getUrl');
const event = readFromDataLayer('event');
const queryPermission = require('queryPermission');
const getContainerVersion = require('getContainerVersion');
const eventTimestamp = getTimestamp();
const endPoint = data.endPoint;
const token = data.token;
const url = getUrl();
const cv = getContainerVersion();
let userAgent;

// Utility for splitting an array into multiple arrays of given size
const splitToBatches = (arr) => {
    const newArr = [];
    for (let i = 0, len = arr.length; i < len; i += 1) {
        newArr.push(arr.slice(i, i + 1));
    }
    return newArr;
};

function onSuccess(success) { log("success"); log(success); }
function onError(err) { log("error"); log(err); }

// The addEventCallback gets two arguments: container ID and a data object with an array of tags that fired
addEventCallback((ctid, eventData) => {
    // Filter out tags that have the "exclude" metadata set to true
    const tags = eventData.tags.filter(t => t.include == 'true');

    // Split the tags into batches of the given size
    const batches = splitToBatches(tags);

    // For each batch, build a payload and dispatch to the endpoint as a GET request
    batches.forEach(tags => {
        let payload = '?eventName=' + event + '&eventTimestamp=' + eventTimestamp;
        tags.forEach((tag) => {
            const tagType = tag.type ? tag.type : 'undefined';
            const tagPrefix = '&tag';
            log(tag);
            payload +=
                tagPrefix + '_sc_token=' + token +
                tagPrefix + '_id=' + tag.id +
                tagPrefix + '_nm=' + tag.name +
                tagPrefix + '_st=' + tag.status +
                tagPrefix + '_ty=' + tagType +
                tagPrefix + '_url=' + url +
                tagPrefix + '_cv=' + cv.version +
                tagPrefix + '_envName=' + cv.environmentName +
                tagPrefix + '_ctid=' + cv.containerId +
                tagPrefix + '_et=' + tag.executionTime;

        });
        sendPixel(endPoint + payload, onSuccess, onError);
    });
});

// After adding the callback, signal tag completion
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_metadata",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "event"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://tag-streaming-dot-tag-monitoring-282106.ts.r.appspot.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Quick Test
  code: runCode();
setup: ''


___NOTES___

Created on 06/07/2020, 17:37:04


